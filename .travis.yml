language: bash
services: docker

env:
  matrix:
    - dir=forks script=base-php
    - dir=forks script=base-python
    - dir=forks script=base-ruby
    - dir=forks script=httpd
    - dir=forks script=openjdk

    - dir=images script=alpine
    - dir=images script=apache
    - dir=images script=memcached
    - dir=images script=node
    - dir=images script=php
    - dir=images script=postgres
    - dir=images script=python
    - dir=images script=redis
    - dir=images script=ruby
    - dir=images script=solr

    # Do not change sorting, the order is important to avoid parallel pushes.
    - dir=stability-tags script=base-php
    - dir=stability-tags script=base-python
    - dir=stability-tags script=base-ruby
    - dir=stability-tags script=httpd
    - dir=stability-tags script=openjdk
    - dir=stability-tags script=drupal-php
    - dir=stability-tags script=wordpress-php
    - dir=stability-tags script=adminer-php
    - dir=stability-tags script=cachet-php
    - dir=stability-tags script=matomo-php
    - dir=stability-tags script=webgrind-php
    - dir=stability-tags script=drupal
    - dir=stability-tags script=wordpress
    - dir=stability-tags script=xhprof

    - dir=upstream script=adminer
    - dir=upstream script=cachet
    - dir=upstream script=drupal
    - dir=upstream script=elasticsearch
    - dir=upstream script=kibana
    - dir=upstream script=mariadb
    - dir=upstream script=matomo
    - dir=upstream script=nginx
    - dir=upstream script=varnish
    - dir=upstream script=webgrind
    - dir=upstream script=wordpress

    - dir=docker4x script=drupal
    - dir=docker4x script=php
    - dir=docker4x script=python
    - dir=docker4x script=ruby
    - dir=docker4x script=wordpress

script:
  - set -e
  - |
      docker run -e GITHUB_MACHINE_USER_API_TOKEN -e GITHUB_MACHINE_USER -e GIT_USER_EMAIL -e GIT_USER_NAME -e DEBUG \
            --rm -v $PWD:/images wodby/alpine:3.8-dev-2.1.0 sh -c "cd /images/${dir} && ./${script}.sh"

notifications:
  email:
    recipients:
      - $NOTIFICATIONS_EMAIL
    on_success: never
    on_failure: always
